name: google-analytics
version: "1.0"
schema_version: 2
description: >
  End-to-end Google Analytics audit and optimization. Covers tracking audit,
  data quality assessment, funnel analysis, audience segmentation, attribution
  modeling, and actionable recommendations. Suitable for GA4 properties seeking
  to improve measurement, identify drop-off points, and optimize conversion.
author: "Loom Community"
tags: [analytics, google-analytics, ga4, measurement, conversion, attribution]

dependencies:
  - pyyaml
  - httpx>=0.27

persona: |
  You are a senior digital analytics consultant specializing in Google Analytics 4.
  You think in event taxonomies, conversion funnels, and attribution models.
  Recommendations must be actionable — specify exact GA4 configurations, GTM tags,
  or data layer changes. Quantify impact where possible (e.g., "fixing this
  tracking gap captures ~15% of currently unattributed conversions"). Distinguish
  between quick wins and structural improvements.

phase_mode: guided

tool_guidance: |
  Use ga_live_api to retrieve live GA4 property metadata and reports when API
  credentials are configured. Prefer pulling fresh data first, then write
  analysis outputs based on retrieved evidence.
  Use CSV for all tabular data (event inventories, funnel metrics, segment
  comparisons). Use Markdown for narrative analysis and recommendations.
  Use the calculator for conversion rate lifts, attribution weighting, and
  statistical significance checks. Always show your calculations.

tools:
  required:
    - ga_live_api
    - calculator
    - spreadsheet
    - document_write
  excluded: []

auth:
  required:
    - provider: google_analytics
      source: api
      modes: [api_key, oauth2_pkce, oauth2_device, env_passthrough]

phases:
  - id: tracking-audit
    description: >
      Audit the current GA4 implementation: event taxonomy, custom dimensions,
      conversions, data streams, and tag configuration. Identify gaps,
      redundancies, and misconfigurations.
    depends_on: []
    model_tier: 2
    verification_tier: 2
    is_critical_path: true
    acceptance_criteria: >
      Complete event inventory with name, parameters, trigger condition, and
      status (firing/not firing/misconfigured). Data stream configuration
      documented. Enhanced measurement settings reviewed. At least 3 tracking
      gaps or issues identified with severity rating.
    deliverables:
      - "tracking-audit.md — GA4 implementation audit with findings"
      - "event-inventory.csv — complete event taxonomy with status"

  - id: data-quality
    description: >
      Assess data quality: sampling rates, data thresholds, consent mode impact,
      cross-domain tracking, session stitching, and data freshness. Quantify
      the gap between actual and reported metrics.
    depends_on: [tracking-audit]
    model_tier: 2
    verification_tier: 2
    acceptance_criteria: >
      Data quality scorecard with metrics for completeness, accuracy,
      timeliness, and consistency. Each dimension scored 1-5 with evidence.
      Consent mode impact quantified (% data loss by region/category).
    deliverables:
      - "data-quality.md — data quality assessment and scorecard"
      - "quality-metrics.csv — quality dimensions with scores and evidence"

  - id: funnel-analysis
    description: >
      Map and analyze key conversion funnels: acquisition to activation,
      activation to engagement, engagement to conversion, conversion to
      retention. Calculate drop-off rates and identify friction points.
    depends_on: [data-quality]
    model_tier: 3
    verification_tier: 2
    is_critical_path: true
    acceptance_criteria: >
      At least 2 funnels mapped with step-by-step conversion rates.
      Drop-off points identified with hypothesized causes. Benchmarks
      cited for comparison. Device and channel segmentation applied.
    deliverables:
      - "funnel-analysis.md — funnel maps with drop-off analysis"
      - "funnel-metrics.csv — step-by-step conversion rates by segment"

  - id: audience-segmentation
    description: >
      Define and analyze audience segments using behavioral signals: engagement
      depth, purchase frequency, channel affinity, lifecycle stage. Build
      GA4 audiences for activation.
    depends_on: [funnel-analysis]
    model_tier: 3
    verification_tier: 2
    acceptance_criteria: >
      4+ segments defined with behavioral criteria, size estimate, and
      value tier. Each segment has a GA4 audience definition (conditions
      and sequences). Segment overlap analysis included.
    deliverables:
      - "audience-segments.md — segment definitions and activation plan"
      - "segment-comparison.csv — segment metrics and value tiers"

  - id: attribution-analysis
    description: >
      Evaluate attribution models: last-click, data-driven, and custom
      position-based. Analyze channel contribution shifts across models.
      Recommend the optimal model with justification.
    depends_on: [funnel-analysis]
    model_tier: 2
    verification_tier: 1
    acceptance_criteria: >
      At least 3 attribution models compared. Channel credit shifts
      quantified (% change from last-click baseline). Model recommendation
      with rationale tied to business model and sales cycle.
    deliverables:
      - "attribution-analysis.md — model comparison and recommendation"
      - "attribution-comparison.csv — channel credits by model"

  - id: recommendations
    description: >
      Synthesize all findings into prioritized recommendations: tracking fixes,
      configuration changes, new events to implement, audiences to activate,
      and reporting improvements. Include implementation effort and expected impact.
    depends_on: [tracking-audit, data-quality, funnel-analysis, audience-segmentation, attribution-analysis]
    model_tier: 3
    verification_tier: 2
    is_synthesis: true
    acceptance_criteria: >
      15+ recommendations ranked by impact and effort (2x2 matrix).
      Each recommendation has: description, GA4/GTM implementation steps,
      estimated impact, effort level (hours), and priority tier (P0/P1/P2).
      Quick wins (high impact, low effort) called out separately.
    deliverables:
      - "recommendations.md — prioritized recommendations with implementation guide"
      - "recommendation-matrix.csv — impact vs effort scoring"
      - "implementation-roadmap.md — phased rollout plan"

tests:
  - id: smoke
    mode: deterministic
    goal: "Run the google-analytics workflow and produce all declared deliverables."
    timeout_seconds: 900
    acceptance:
      phases:
        must_include: [tracking-audit, data-quality, funnel-analysis, audience-segmentation, attribution-analysis, recommendations]
      deliverables:
        must_exist: [tracking-audit.md, event-inventory.csv, data-quality.md, quality-metrics.csv, funnel-analysis.md, funnel-metrics.csv, audience-segments.md, segment-comparison.csv, attribution-analysis.md, attribution-comparison.csv, recommendations.md, recommendation-matrix.csv, implementation-roadmap.md]
      verification:
        forbidden_patterns: ["Expected deliverable '.*' not found", "\\[TBD\\]|\\[TODO\\]|\\[INSERT\\]|\\[PLACEHOLDER\\]"]

  - id: live-canary
    mode: live
    goal: "Audit and optimize a GA4 setup and produce a recommendation package."
    timeout_seconds: 1200
    requires_network: true

verification:
  policy:
    mode: llm_first
    static_checks:
      tool_success_policy: safety_integrity_only
      file_integrity_policy: enforce_nonempty_changed_files
      syntax_policy: enforce_parseable_artifacts
      deliverable_existence_policy: enforce_declared_deliverables
    semantic_checks:
      - id: process-rules
        check: "Apply process-defined verification rules and acceptance criteria."
        severity: error
        enforcement: hard
        scope: phase
    output_contract:
      required_fields:
        - passed
        - outcome
        - reason_code
        - severity_class
        - confidence
        - feedback
        - issues
        - metadata
      metadata_fields:
        - coverage_gaps
        - evidence_quality
        - quantified_recommendation_count
    outcome_policy:
      pass_states: [pass, pass_with_warnings, partial_verified]
      fail_states: [fail]
  remediation:
    strategies:
      - id: targeted-remediation
        retry_strategy: unconfirmed_data
        description: "Address failing checks with minimal targeted edits."
    default_strategy: targeted-remediation
    critical_path_behavior: block
    retry_budget:
      max_attempts: 2
    transient_retry_policy:
      retry_on_transient: true
  rules:
    - name: no-placeholders
      description: "No placeholder text in deliverables"
      check: "\\[TBD\\]|\\[TODO\\]|\\[INSERT\\]|\\[PLACEHOLDER\\]|XX%|N/A"
      severity: error
      type: regex
      target: deliverables
      enforcement: hard
      applies_to_phases: ["*"]
    - name: metrics-quantified
      description: "All recommendations must include quantified expected impact"
      check: >
        Review each recommendation. Every recommendation must include a
        quantified expected impact (percentage lift, absolute number, or
        range). Flag any recommendation that says "improve" without a number.
      severity: warning
      type: llm
      applies_to_phases: [recommendations]
    - name: ga4-specific
      description: "Recommendations must reference specific GA4 features"
      check: >
        Verify that implementation steps reference actual GA4 or GTM
        features (event parameters, custom dimensions, audiences, triggers,
        data layer pushes). Flag generic advice that could apply to any tool.
      severity: warning
      type: llm
      applies_to_phases: [tracking-audit, recommendations]
    - name: funnel-math-check
      description: "Funnel conversion rates must be mathematically consistent"
      check: >
        For each funnel, verify that step-to-step conversion rates multiply
        to equal the overall funnel conversion rate. Flag any arithmetic
        inconsistency greater than 1%.
      severity: error
      type: llm
      applies_to_phases: [funnel-analysis, recommendations]

evidence:
  record_schema:
    required_fields: [evidence_id, tool, source_url, created_at, quality]
    facets: [target, entity, subject, region, category, segment]
  extraction:
    include_result_facets: true
    arg_mappings:
      target: [target, entity, property, account]
      region: [region, geography, country]
      category: [category, dimension, theme]
  summarization:
    max_entries: 12
    include_facets: true

prompt_contracts:
  evidence_contract:
    enabled: true
    applies_to_phases: ["*"]
  executor_constraints: |
    Keep claims traceable to GA4 evidence and sources.
    Quantify impact in recommendations whenever possible.
    If evidence is unavailable, label assumptions explicitly.
  verifier_constraints: |
    Apply process rules and acceptance criteria. Use metadata fields only
    when inferable from artifacts and evidence.
  remediation_instructions:
    default: |
      Preserve validated work and patch only failing sections.
      Prioritize evidence linkage and quantified recommendation gaps.

memory:
  extract_types:
    - type: tracking_gap
      description: "Missing or misconfigured event, parameter, or conversion"
    - type: data_quality_issue
      description: "Data completeness, accuracy, or consistency problem with impact quantified"
    - type: conversion_insight
      description: "Funnel drop-off pattern or conversion rate anomaly with segment context"
    - type: audience_signal
      description: "Behavioral pattern that defines a high-value or at-risk segment"
    - type: attribution_finding
      description: "Channel contribution shift or attribution model insight"
    - type: implementation_decision
      description: "Chosen approach for a tracking or configuration change with rationale"
  extraction_guidance: |
    Prioritize findings that change measurement accuracy or reveal hidden
    conversion opportunities. Always include the quantified impact and the
    specific GA4 configuration involved.

workspace_analysis:
  scan_for:
    - "*.csv — exported GA4 data, event logs, or audience exports"
    - "*.json — GTM container exports or data layer schemas"
    - "*.md — existing analytics documentation or briefs"
  guidance: |
    Look for existing GA4 exports, GTM container files, or analytics
    documentation. Reference actual data rather than making assumptions.
    If a GTM container export exists, parse it for tag and trigger inventory.

planner_examples:
  - goal: "Audit and optimize GA4 for a B2B SaaS with free trial funnel"
    subtasks:
      - id: tracking-audit
        description: "Audit GA4 event taxonomy — map all events, check enhanced measurement, review custom dimensions for lead scoring"
        depends_on: []
        model_tier: 2
      - id: data-quality
        description: "Assess consent mode impact on EU traffic, check cross-domain tracking between marketing site and app"
        depends_on: [tracking-audit]
        model_tier: 2
      - id: funnel-analysis
        description: "Map visitor → trial signup → activation → paid conversion funnel, segment by channel and device"
        depends_on: [data-quality]
        model_tier: 3
      - id: audience-segmentation
        description: "Define segments: trial-not-activated, power-users, at-risk-churn, expansion-ready"
        depends_on: [funnel-analysis]
        model_tier: 3
      - id: attribution-analysis
        description: "Compare last-click vs data-driven attribution for trial signups across paid search, organic, and content channels"
        depends_on: [funnel-analysis]
        model_tier: 2
      - id: recommendations
        description: "Synthesize into tracking fixes, new events for product-qualified leads, audience activation plan, and attribution model recommendation"
        depends_on: [tracking-audit, data-quality, funnel-analysis, audience-segmentation, attribution-analysis]
        model_tier: 3

  - goal: "Optimize GA4 for an e-commerce site with multi-step checkout"
    subtasks:
      - id: tracking-audit
        description: "Audit e-commerce event implementation — verify purchase, add_to_cart, begin_checkout, view_item events and parameters"
        depends_on: []
        model_tier: 2
      - id: data-quality
        description: "Check transaction data accuracy vs backend, assess refund tracking, verify currency and tax handling"
        depends_on: [tracking-audit]
        model_tier: 2
      - id: funnel-analysis
        description: "Map product view → add to cart → checkout → purchase funnel, segment by product category and traffic source"
        depends_on: [data-quality]
        model_tier: 3
      - id: audience-segmentation
        description: "Define segments: cart-abandoners, repeat-purchasers, high-AOV, browse-only, category-loyal"
        depends_on: [funnel-analysis]
        model_tier: 3
      - id: attribution-analysis
        description: "Compare attribution models for purchase conversions, analyze assist vs last-click for email and social channels"
        depends_on: [funnel-analysis]
        model_tier: 2
      - id: recommendations
        description: "Prioritize checkout friction fixes, enhanced e-commerce events, remarketing audiences, and attribution model for ROAS optimization"
        depends_on: [tracking-audit, data-quality, funnel-analysis, audience-segmentation, attribution-analysis]
        model_tier: 3

replanning:
  triggers: |
    - Tracking audit reveals fundamental implementation issues requiring rebuild
    - Data quality is too low to trust funnel metrics
    - Key conversion events are missing or misconfigured
    - Business model doesn't fit standard funnel analysis
  guidance: |
    If tracking is fundamentally broken, prioritize a tracking fix plan before
    attempting funnel or attribution analysis. If data quality is below 3/5,
    expand the data quality phase to include remediation steps before proceeding.
    If the business model is non-standard (e.g., marketplace, subscription with
    long consideration), adapt funnel definitions accordingly.
